name: Deploy Static Website to Azure Web App

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # âœ… Verify secrets are configured
      - name: Verify required secrets
        run: |
          if [ -z "${{ secrets.AZURE_CREDENTIALS }}" ]; then
            echo "âŒ AZURE_CREDENTIALS secret is missing!"
            exit 1
          fi
          echo "âœ… All required secrets are configured"

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # ğŸ§ª Run localStorage and score tests
      - name: Run game logic tests
        run: |
          echo "ğŸ§ª Running localStorage and score calculation tests..."
          node test.js

      # ğŸ”§ Install linters
      - name: Install linters (HTMLHint, Stylelint, ESLint)
        run: |
          npm install -g htmlhint stylelint eslint

      # ğŸ” Lint HTML + export report
      - name: Lint HTML files
        run: |
          mkdir -p reports
          htmlhint "**/*.html" -f json > reports/htmlhint-report.json || true

      # ğŸ” Lint CSS files
      - name: Lint CSS files
        run: |
          stylelint "**/*.css" --ignore-path .gitignore --formatter json > reports/stylelint-report.json || true

      # ğŸ” Lint JavaScript files
      - name: Lint JavaScript files
        run: |
          eslint "**/*.js" --ignore-path .gitignore --format json > reports/eslint-report.json || true

      # ğŸ“¤ Upload lint reports
      - name: Upload lint reports
        uses: actions/upload-artifact@v4
        with:
          name: lint-reports
          path: reports/

      # âŒ Fail if any linter found errors
      - name: Check for linting errors
        run: |
          echo ""
          echo "ğŸ“Š ========== LINTING SUMMARY =========="
          echo ""
          
          html_errors=$(grep -c "\"error\"" reports/htmlhint-report.json || echo "0")
          css_errors=$(grep -c "\"severity\": \"error\"" reports/stylelint-report.json || echo "0")
          js_errors=$(grep -c "\"severity\": \"error\"" reports/eslint-report.json || echo "0")
          
          echo "HTML Linter: $html_errors error(s)"
          echo "CSS Linter:  $css_errors error(s)"
          echo "JS Linter:   $js_errors error(s)"
          echo ""
          
          total_errors=$((html_errors + css_errors + js_errors))
          
          if [ $total_errors -eq 0 ]; then
            echo "âœ… All linters passed! No errors found."
            echo "========================================"
            echo ""
            exit 0
          else
            echo "âŒ Linting found $total_errors error(s)!"
            echo "========================================"
            echo ""
            if [ "$html_errors" -gt 0 ]; then
              echo "ğŸ“„ HTML errors details:"
              cat reports/htmlhint-report.json | grep -o "\"error\"" | wc -l || true
              echo ""
            fi
            if [ "$css_errors" -gt 0 ]; then
              echo "ğŸ¨ CSS errors details:"
              grep "\"severity\": \"error\"" reports/stylelint-report.json || true
              echo ""
            fi
            if [ "$js_errors" -gt 0 ]; then
              echo "ğŸ“œ JS errors details:"
              grep "\"severity\": \"error\"" reports/eslint-report.json || true
              echo ""
            fi
            exit 1
          fi

      # ğŸš€ Deploy
      - name: Deploy to Azure Web App
        if: success()
        uses: azure/webapps-deploy@v3
        with:
          app-name: "SIO-CSS-Game"
          package: "."
